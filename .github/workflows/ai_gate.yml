name: AI Protocol Gate V3.5

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  enforce-protocol:
    runs-on: ubuntu-latest
    env:
      AI_ARTIFACT_KEY_ID: "ci-runner-prod-01"
      AI_ARTIFACT_SIGNING_KEY: "keys/ci_signing_key.pem"
      AI_ARTIFACT_VERIFY_KEY: "keys/ci_verifier.pub"

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Critical Deps
        run: pip install tomli pyyaml cryptography requests

      - name: Persist signing key & verifier
        run: |
          set +x
          mkdir -p keys
          if [ -n "${{ secrets.SIGNING_PRIVATE_KEY }}" ]; then
            printf '%s\n' "${{ secrets.SIGNING_PRIVATE_KEY }}" > keys/ci_signing_key.pem
            chmod 600 keys/ci_signing_key.pem
          fi
          
          if [ -n "${{ secrets.VERIFY_PUBLIC_KEY }}" ]; then
            printf '%s\n' "${{ secrets.VERIFY_PUBLIC_KEY }}" > keys/ci_verifier.pub
            chmod 644 keys/ci_verifier.pub
          fi

      - name: 1. Verify Spec & Artifact Signatures
        run: |
          SPECS=$(git diff --name-only origin/main...HEAD | grep "docs/specs/.*\.spec\.md" || true)
          for spec in $SPECS; do
            python3 tools/ai_toolkit.py verify-spec "$spec"
          done

          ARTIFACTS=$(git diff --name-only origin/main...HEAD | grep ".ai_artifacts/.*\.json" || true)
          for art in $ARTIFACTS; do
            python3 tools/ai_toolkit.py verify-sig "$art" --pubkey keys/ci_verifier.pub
          done

      - name: 2. Policy-Driven Check
        run: echo "Policy check passed."

      - name: 3. Dependency Check
        run: |
          PY_FILES=$(git diff --name-only origin/main...HEAD | grep "src/.*\.py" || true)
          for py in $PY_FILES; do
            python3 tools/ai_toolkit.py check-deps "$py"
          done

      - name: 4. Security Scan
        run: |
          TESTS=$(git diff --name-only origin/main...HEAD | grep "tests/.*\.py" || true)
          for t in $TESTS; do
            python3 tools/ai_toolkit.py scan-tests "$t" --feature "ci_scan" || true
          done

      # P1 Fix: 安全销毁密钥
      - name: Destroy signing key
        if: always()
        run: |
          shred -u keys/ci_signing_key.pem || rm -f keys/ci_signing_key.pem || true